function Agent(t){this.i=t,this.settings=Object.assign({},agentDefaults),this.noiseZ=Math.random()*this.settings.interAgentNoiseZRange,this.setLocation(),geometry.vertices.push(new THREE.Vector3(this.location.previous.x,this.location.previous.y,1e3),new THREE.Vector3(this.location.current.x,this.location.current.y,1e3)),this.initColor()}function ColorMixer(t,e,i,s,o){push(),this.angerData=[19,.05,.9],this.joyData=[55,.02,.9],this.calmData=[0,.1,.8],this.disgustData=[162,.1,.8],this.sadnessData=[190,.1,.8],this.fearData=[210,.1,.8],this.surpriseData=[285,.1,.65],this.loveData=[0,.1,.8],this.emotionsData={anger:this.angerData,joy:this.joyData,calm:this.calmData,disgust:this.disgustData,sadness:this.sadnessData,fear:this.fearData,surprise:this.surpriseData,love:this.loveData},this.blendFactor=o,this.mixedVbo=createImage(t.width,t.height);var r=this.emotionsData[s[0]],a=this.emotionsData[s[1]];this.customBlend=i,this.canvasSize=t,this.palettes=[new Palette(t.width,t.height,e,r),new Palette(t.width,t.height,e,a)],this.createMixedPalette(),this.mixedVbo.loadPixels(),pop()}function Palette(t,e,i,s){push(),noiseDetail(10),noiseSeed(random(1e4)),this.paletteScaleFactor=i,this.palWidth=t/i,this.palHeight=e/i,this.xPeriod=1,this.yPeriod=1,this.turbPower=2,this.turbSize=170,this.marbleVbo=createImage(this.palWidth,this.palHeight),this.huesVbo=createImage(this.palWidth,100),this.hueOffset=random(1e4),this.hueOffsetDebug=this.hueOffset,colorMode(HSB,360),this.c=color(s[0],100,100),this.hueRange=s[1],this.minMarbleBrightness=s[2],this.noiseStep=.005,this.randomXoffset=random(1e3),this.randomYoffset=random(5e3),this.createMarble(),this.createHues(),this.marbleVbo.loadPixels(),this.huesVbo.loadPixels(),pop()}function setup(){camera=new THREE.PerspectiveCamera(30,window.innerWidth/window.innerHeight,.1,1500),camera.position.set(0,0,-10),scene=new THREE.Scene;var t=new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,opacity:.1,transparent:!0});colorMixer=new ColorMixer(canvasSize,settings.paletteScaleFactor,settings.customBlend,["surprise","anger"],settings.blendFactor);for(var e=0;e<settings.agents;e++)agents.push(new Agent(e));var i=new THREE.LineSegments(geometry,t);scene.add(i),renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:!0,antialias:!0,alpha:!0}),renderer.setClearColor(16777215,0),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.sortObjects=!1,renderer.autoClearColor=!1,camera.lookAt(scene.position),document.body.appendChild(renderer.domElement),stats.showPanel(1),document.body.appendChild(stats.dom),myDraw()}function myDraw(){stats.begin();for(var t=0;t<agents.length;t++)agents[t].update();stats.end(),geometry.verticesNeedUpdate=!0,geometry.colorsNeedUpdate=!0,renderer.render(scene,camera),requestAnimationFrame(myDraw)}Agent.prototype.setLocation=function(){this.location={current:{x:Math.floor(Math.random()*canvasSize.width),y:Math.floor(Math.random()*canvasSize.height)}},this.location.previous={x:this.location.current.x,y:this.location.current.y}},Agent.prototype.initColor=function(){this.agentColor=colorMixer.getColor(this.location.current.x,this.location.current.y),c=new THREE.Color("rgb("+this.agentColor[0]+","+this.agentColor[1]+","+this.agentColor[2]+")"),geometry.colors.push(c,c)},Agent.prototype.setColor=function(){this.agentColor=colorMixer.getColor(this.location.current.x,this.location.current.y);var t=new THREE.Color("rgb("+this.agentColor[0]+","+this.agentColor[1]+","+this.agentColor[2]+")");geometry.colors[2*this.i].set(t),geometry.colors[2*this.i+1].set(t)},Agent.prototype.resetAgent=function(){this.setLocation(),this.setColor()},Number.prototype.map=function(t,e,i,s){return(this-t)*(s-i)/(e-t)+i},Agent.prototype.update=function(){var t=noise(this.location.current.x/this.settings.noiseScale+this.settings.randomSeed,this.location.current.y/this.settings.noiseScale+this.settings.randomSeed,this.noiseZ+this.settings.randomSeed),e=t.map(0,1,-1,1);e=e*(this.settings.maxAngleSpan*Math.PI/180)+this.settings.randomInitialDirection,this.location.current.x+=Math.cos(e)*this.settings.speed,this.location.current.y+=Math.sin(e)*this.settings.speed,(this.location.current.x<0||this.location.current.x>canvasSize.width||this.location.current.y<0||this.location.current.y>canvasSize.height)&&this.resetAgent(),this.noiseZ+=this.settings.noiseZStep,geometry.vertices[2*this.i].x=this.location.previous.x-canvasSize.width/2,geometry.vertices[2*this.i].y=this.location.previous.y-canvasSize.height/2,geometry.vertices[2*this.i+1].x=this.location.current.x-canvasSize.width/2,geometry.vertices[2*this.i+1].y=this.location.current.y-canvasSize.height/2,this.location.previous.x=this.location.current.x,this.location.previous.y=this.location.current.y},ColorMixer.prototype.getColor=function(t,e){return this.mixedVbo.get(t,e)},ColorMixer.prototype.createMixedPalette=function(){push(),colorMode(RGB,255);var t,e,i;this.mixedVbo.loadPixels();for(var s=0;s<this.canvasSize.width;s++)for(var o=0;o<this.canvasSize.height;o++)t=color(this.palettes[0].getColor(s,o)),e=color(this.palettes[1].getColor(s,o)),i=this.mixColors(t,e),this.mixedVbo.set(s,o,i);this.mixedVbo.updatePixels(),pop()},ColorMixer.prototype.mixColors=function(t,e){return this.customBlend?saturation(t)<saturation(e)*this.blendFactor?e:t:blendColor(t,e,DARKEST)},Palette.prototype.getColor=function(t,e){return this.marbleVbo.get(t,e)},Palette.prototype.createMarble=function(){push(),this.marbleVbo.loadPixels(),colorMode(HSB,1);for(var t=0;t<this.palWidth;t++){var e=hue(this.c)+map(noise(this.hueOffset),0,1,-this.hueRange,this.hueRange);e<0&&(e+=1);for(var i=0;i<this.palHeight;i++){var s=(t+this.randomXoffset)*this.xPeriod/this.palWidth+(i+this.randomYoffset)*this.yPeriod/this.palHeight+this.turbPower*noise(t/this.turbSize,i/this.turbSize),o=abs(sin(3.14159*s)),r=color(e,1-o,map(o,0,1,this.minMarbleBrightness,1));this.marbleVbo.set(t,i,r)}this.hueOffset+=this.noiseStep}this.marbleVbo.updatePixels(),pop()},Palette.prototype.createHues=function(){push(),this.huesVbo.loadPixels(),colorMode(HSB,1);for(var t=0;t<this.palWidth;t++){var e=hue(this.c)+map(noise(this.hueOffsetDebug),0,1,-this.hueRange,this.hueRange);e<0&&(e+=1);for(var i=color(e,1,1),s=0;s<this.palHeight;s++)this.huesVbo.set(t,s,i);this.hueOffsetDebug+=this.noiseStep}this.huesVbo.updatePixels(),pop()};var canvasSize={width:800,height:800},settings={agents:3e4,fadeAlpha:0,noiseDet:4,overlayAlpha:0,blendFactor:.2,paletteScaleFactor:1,customBlend:!0,imageChoice:0,debug:!1},agentDefaults={noiseScale:150,randomSeed:0,agentsAlpha:20,strokeWidth:2,maxAngleSpan:220,speed:3,interAgentNoiseZRange:0,noiseZStep:.001,randomInitialDirection:0},stats=new Stats,agents=[],colorMixer,camera,scene,renderer,geometry;geometry=new THREE.Geometry,perlin=noise;