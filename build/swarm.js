function Agent(t,e,i,o,n,s){this.i=t,this.settings=Object.assign({},e),this.canvasSize=i,this.limits=o,this.colorMixer=s,this.geometry=n,this.noiseZ=Math.random()*this.settings.interAgentNoiseZRange,this.widthHeighRatio=i.width/i.height,this.setLocation(),n.vertices.push(new THREE.Vector3(this.location.previous.x,this.location.previous.y,1e3),new THREE.Vector3(this.location.current.x,this.location.current.y,1e3)),this.setColor()}function ColorMixer(t,e,i,o,n,s){this.blendFactor=s,this.mixedVbo=[[]];var r=o[n[0]],a=o[n[1]];this.customBlend=i,this.canvasSize=t,this.palettes=[new Palette(t.width,t.height,e,r),new Palette(t.width,t.height,e,a)],this.createMixedPalette()}function Palette(t,e,i,o){customNoise.noiseDetail(10),customNoise.noiseSeed(1e4*Math.random()),this.paletteScaleFactor=i,this.palWidth=t/i,this.palHeight=e/i,this.xPeriod=1,this.yPeriod=1,this.turbPower=2,this.turbSize=170,this.marbleVbo=[[]],this.hueOffset=1e4*Math.random(),this.hueOffsetDebug=this.hueOffset,this.c=o[0]/360,this.hueRange=o[1],this.minMarbleBrightness=o[2],this.noiseStep=.005,this.randomXoffset=1e3*Math.random(),this.randomYoffset=5e3*Math.random(),this.createMarble()}function HSB2HSL(t,e,i){var o=(2-e)*i/2;return e=o&&o<1?e*i/(o<.5?2*o:2-2*o):e,[t,e,o]}Agent.prototype.newColorMixer=function(t){this.colorMixer=t},Agent.prototype.setLocation=function(){this.location={current:{x:Math.floor(Math.random()*(this.canvasSize.width+2*this.limits.range)-this.limits.range),y:Math.floor(Math.random()*(this.canvasSize.height+2*this.limits.range)-this.limits.range)}},this.location.previous={x:this.location.current.x,y:this.location.current.y}},Agent.prototype.constrain=function(t,e,i){return Math.round(Math.min(Math.max(t,e),i))},Agent.prototype.setColor=function(){var t=this.constrain(this.location.current.x,0,this.canvasSize.width-1),e=this.constrain(this.location.current.y,0,this.canvasSize.height-1);this.agentColor=this.colorMixer.getColor(t,e);var i=HSB2HSL(this.agentColor[0],this.agentColor[1],this.agentColor[2]),o=(new THREE.Color).setHSL(i[0],i[1],i[2]);this.geometry.colors[2*this.i]?(this.geometry.colors[2*this.i].set(o),this.geometry.colors[2*this.i+1].set(o)):this.geometry.colors.push(o,o)},Agent.prototype.resetAgent=function(){this.setLocation(),this.setColor()},Agent.prototype.map=function(t,e,i,o,n){return(t-e)/(i-e)*(n-o)+o},Agent.prototype.update=function(){var t=this.location.current.x/(this.settings.noiseScale*this.widthHeighRatio)+this.settings.randomSeed,e=this.location.current.y/this.settings.noiseScale+this.settings.randomSeed,i=this.noiseZ+this.settings.randomSeed,o=customNoise.noise(t,e,i),n=this.map(o,0,1,-1,1);n=n*(this.settings.maxAngleSpan*Math.PI/180)+this.settings.randomInitialDirection,this.location.current.x+=Math.cos(n)*this.settings.speed,this.location.current.y+=Math.sin(n)*this.settings.speed,(this.location.current.x<0-this.limits.range||this.location.current.x>this.canvasSize.width+this.limits.range||this.location.current.y<0-this.limits.range||this.location.current.y>this.canvasSize.height+this.limits.range)&&this.resetAgent(),this.noiseZ+=this.settings.noiseZStep,this.geometry.vertices[2*this.i].x=this.location.previous.x-this.canvasSize.width/2,this.geometry.vertices[2*this.i].y=this.location.previous.y-this.canvasSize.height/2,this.geometry.vertices[2*this.i+1].x=this.location.current.x-this.canvasSize.width/2,this.geometry.vertices[2*this.i+1].y=this.location.current.y-this.canvasSize.height/2,this.location.previous.x=this.location.current.x,this.location.previous.y=this.location.current.y},ColorMixer.prototype.getColor=function(t,e){return this.mixedVbo[t][e]},ColorMixer.prototype.createMixedPalette=function(){for(var t,e,i,o=0;o<this.canvasSize.width;o++){this.mixedVbo[o]=[];for(var n=0;n<this.canvasSize.height;n++)t=this.palettes[0].getColor(o,n),e=this.palettes[1].getColor(o,n),i=this.mixColors(t,e),this.mixedVbo[o].push(i)}},ColorMixer.prototype.mixColors=function(t,e){if(this.customBlend)return t[1]<e[1]*this.blendFactor?e:t},Palette.prototype.getColor=function(t,e){return this.marbleVbo[Math.floor(t/this.paletteScaleFactor)][Math.floor(e/this.paletteScaleFactor)]},Palette.prototype.map=function(t,e,i,o,n){return(t-e)/(i-e)*(n-o)+o},Palette.prototype.createMarble=function(){for(var t=0;t<this.palWidth;t++){var e=this.c+this.map(customNoise.noise(this.hueOffset),0,1,-this.hueRange,this.hueRange);e<0&&(e+=1),this.marbleVbo[t]=[];for(var i=0;i<this.palHeight;i++){var o=(t+this.randomXoffset)*this.xPeriod/this.palWidth+(i+this.randomYoffset)*this.yPeriod/this.palHeight+this.turbPower*customNoise.noise(t/this.turbSize,i/this.turbSize),n=Math.abs(Math.sin(3.14159*o)),s=[e,1-n,this.map(n,0,1,this.minMarbleBrightness,1)];this.marbleVbo[t].push(s)}this.hueOffset+=this.noiseStep}},function(t){function e(){function t(){if("404"==s.status)return void i();var t=JSON.parse(s.responseText);w.emotions=[t.dominant[0][0],t.dominant[1][0]],w.blendFactor=t.dominant[1][1]/t.dominant[0][1],w.word=t.word,w.dominantEmotionProportion=t.dominant[0][1];var e=b?o:n;e()}function i(){console.error("Swarm: failed to connect to sentiment service, loading default emotions"),w.emotions=["joy","love"],w.word="joyful",w.dominantEmotionProportion=.5,n()}var s=new XMLHttpRequest;s.addEventListener("load",t),s.addEventListener("error",i),s.open("GET",c+"/sentiment/"),s.send(),setTimeout(e,1e3*w.fetchPeriod)}function i(){d=new ColorMixer(f,w.paletteScaleFactor,w.customBlend,S,w.emotions,w.blendFactor);for(var t=0;t<M.length;t++)M[t].newColorMixer(d)}function o(){i(),r(w.word,[S[w.emotions[0]],S[w.emotions[1]]])}function n(){b=!0,a(w.word,[S[w.emotions[0]],S[w.emotions[1]]]),i(),w.agents=f.width*f.height*w.sizeAgentRatio,m=new THREE.OrthographicCamera(f.width/-2,f.width/2,f.height/2,f.height/-2,.1,1e4),m.position.set(0,0,-10),u=new THREE.Scene;for(var t=new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,opacity:.1,transparent:!0,linewidth:1}),e=0;e<w.agents;e++)M.push(new Agent(e,y,f,v,p,d));var o=new THREE.LineSegments(p,t);u.add(o),g=new THREE.WebGLRenderer({preserveDrawingBuffer:!0,antialias:!0,alpha:!0}),g.setClearColor(16777215,0),g.setPixelRatio(window.devicePixelRatio),g.setSize(f.width,f.height),g.sortObjects=!1,g.autoClearColor=!1,m.lookAt(u.position),w.container.appendChild(g.domElement),x.showPanel(1),document.body.appendChild(x.dom),h()}function s(t){var e=.75,i=HSB2HSL(t[0][0],t[0][1],t[0][2]),o=HSB2HSL(t[1][0],t[1][1],t[1][2]),n="hsla("+o[0]+",100%,"+75*o[2]+"%, "+e+")",s="hsla("+i[0]+",100%,"+75*i[2]+"%,"+e+")",r="linear-gradient(70deg, "+n+", "+s+")";n="hsla("+i[0]+",100%,"+75*i[2]+"%,"+e+")",s="hsla("+i[0]+",75%,"+75*i[2]+"%,"+e+")";var a="linear-gradient(45deg, "+n+","+s+")";return[r,a]}function r(t,e){var i=document.getElementById("swarm-logo"),o=document.getElementById("swarm-text"),n=document.getElementById("swarm-emotion-word"),r=s(e);i.style.backgroundImage=r[0],o.style.backgroundImage=r[0],n.innerHTML=t,n.style.backgroundImage=r[1]}function a(t,e){t||(t="splendid");var i=document.createElement("div");i.className="swarm-overlay";var o=document.createElement("div");o.className="logo";var n=document.createElement("div");n.className="text",o.innerHTML='<img src="assets/ssw-logo.png" height="120">';var r=document.createElement("span"),a=document.createElement("span");r.appendChild(document.createTextNode("Today the world is feeling")),a.appendChild(document.createTextNode(t)),n.appendChild(r),n.appendChild(a);var h=s(e);o.style.backgroundImage=h[0],r.style.backgroundImage=h[0],a.style.backgroundImage=h[1],o.id="swarm-logo",r.id="swarm-text",a.id="swarm-emotion-word",i.appendChild(o),i.appendChild(n),i.style.width=f.width+"px",i.style.height=f.height+"px",w.container.appendChild(i)}function h(){x.begin();for(var t=0;t<M.length;t++)M[t].update();x.end(),p.verticesNeedUpdate=!0,p.colorsNeedUpdate=!0,g.render(u,m),requestAnimationFrame(h)}var c,l=t.swarm={};l.create=function(t,i){var o=document.getElementsByClassName(t)[0];w.container=o,f={width:o.offsetWidth,height:o.offsetHeight},w.originalSize=Object.create(f),c=i,e()},l.resize=function(){f={width:w.container.offsetWidth,height:w.container.offsetHeight};var t=f.width/w.originalSize.width;m.zoom=t,m.updateProjectionMatrix()},l.testNewColor=function(){w.emotions=["anger","surprise"],w.word="alarmed",o()};var d,m,u,g,p,f={width:window.innerWidth,height:window.innerHeight},v={range:100},w={agents:7e4,sizeAgentRatio:.033,fadeAlpha:0,noiseDet:4,overlayAlpha:0,blendFactor:.2,paletteScaleFactor:2,customBlend:!0,imageChoice:0,debug:!1,emotions:["joy","anger"],dominantEmotionProportion:.5,fetchPeriod:60},y={noiseScale:200,randomSeed:0,agentsAlpha:20,strokeWidth:2,maxAngleSpan:220,speed:3,interAgentNoiseZRange:0,noiseZStep:.001,randomInitialDirection:0},S={anger:[19,.05,.9],joy:[55,.02,.9],calm:[0,.1,.8],disgust:[162,.1,.8],sadness:[190,.1,.8],fear:[210,.1,.8],surprise:[285,.1,.65],love:[0,.1,.8]},x=new Stats,M=[];p=new THREE.Geometry;var b=!1}(window)(function(t){var e,i=t.customNoise={},o=4,n=1<<o,s=8,r=1<<s,a=4095,h=4,c=.5,l=function(t){return.5*(1-Math.cos(t*Math.PI))};i.noise=function(t,i,d){if(i=i||0,d=d||0,null==e){e=new Array(a+1);for(var m=0;m<a+1;m++)e[m]=Math.random()}t<0&&(t=-t),i<0&&(i=-i),d<0&&(d=-d);for(var u,g,p,f,v,w=Math.floor(t),y=Math.floor(i),S=Math.floor(d),x=t-w,M=i-y,b=d-S,C=0,E=.5,H=0;H<h;H++){var P=w+(y<<o)+(S<<s);u=l(x),g=l(M),p=e[P&a],p+=u*(e[P+1&a]-p),f=e[P+n&a],f+=u*(e[P+n+1&a]-f),p+=g*(f-p),P+=r,f=e[P&a],f+=u*(e[P+1&a]-f),v=e[P+n&a],v+=u*(e[P+n+1&a]-v),f+=g*(v-f),p+=l(b)*(f-p),C+=p*E,E*=c,w<<=1,x*=2,y<<=1,M*=2,S<<=1,b*=2,x>=1&&(w++,x--),M>=1&&(y++,M--),b>=1&&(S++,b--)}return C},i.noiseDetail=function(t,e){t>0&&(h=t),e>0&&(c=e)},i.noiseSeed=function(t){var i=function(){var t,e,i=4294967296,o=1664525,n=1013904223;return{setSeed:function(o){e=t=(null==o?Math.random()*i:o)>>>0},getSeed:function(){return t},rand:function(){return e=(o*e+n)%i,e/i}}}();i.setSeed(t),e=new Array(a+1);for(var o=0;o<a+1;o++)e[o]=i.rand()}})(window);