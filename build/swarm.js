function Agent(i,agentDefaults,canvasSize,limits,geometry,colorMixer){this.i=i;this.settings=Object.assign({},agentDefaults);this.canvasSize=canvasSize;this.limits=limits;this.colorMixer=colorMixer;this.geometry=geometry;this.noiseZ=Math.random()*this.settings.interAgentNoiseZRange;this.widthHeighRatio=canvasSize.width/canvasSize.height;this.setLocation();geometry.vertices.push(new THREE.Vector3(this.location.previous.x,this.location.previous.y,0),new THREE.Vector3(this.location.current.x,this.location.current.y,0));this.setColor()}Agent.prototype.newColorMixer=function(colorMixer){this.colorMixer=colorMixer};Agent.prototype.setLocation=function(){this.location={current:{x:Math.floor(Math.random()*(this.canvasSize.width+this.limits.range*2)-this.limits.range),y:Math.floor(Math.random()*(this.canvasSize.height+this.limits.range*2)-this.limits.range)}};this.location.previous={x:this.location.current.x,y:this.location.current.y}};Agent.prototype.constrain=function(value,min,max){return Math.round(Math.min(Math.max(value,min),max))};Agent.prototype.setColor=function(){var x=this.constrain(this.location.current.x,0,this.canvasSize.width-1);var y=this.constrain(this.location.current.y,0,this.canvasSize.height-1);this.agentColor=this.colorMixer.getColor(x,y);var colorHSL=HSB2HSL(this.agentColor[0],this.agentColor[1],this.agentColor[2]);var color=(new THREE.Color).setHSL(colorHSL[0],colorHSL[1],colorHSL[2]);if(this.geometry.colors[this.i*2]){this.geometry.colors[this.i*2].set(color);this.geometry.colors[this.i*2+1].set(color)}else{this.geometry.colors.push(color,color)}};Agent.prototype.resetAgent=function(){this.setLocation();this.setColor()};Agent.prototype.map=function(n,start1,stop1,start2,stop2){return(n-start1)/(stop1-start1)*(stop2-start2)+start2};Agent.prototype.update=function(){var nx=this.location.current.x/this.settings.noiseScale+this.settings.randomSeed;var ny=this.location.current.y/this.settings.noiseScale+this.settings.randomSeed;var nz=this.noiseZ+this.settings.randomSeed;var noiseVal=customNoise.noise(nx,ny,nz);var angle=this.map(noiseVal,0,1,-1,1);angle=angle*(this.settings.maxAngleSpan*Math.PI/180)+this.settings.randomInitialDirection;this.location.current.x+=Math.cos(angle)*this.settings.speed;this.location.current.y+=Math.sin(angle)*this.settings.speed;if(this.location.current.x<0-this.limits.range||this.location.current.x>this.canvasSize.width+this.limits.range||this.location.current.y<0-this.limits.range||this.location.current.y>this.canvasSize.height+this.limits.range)this.resetAgent();this.noiseZ+=this.settings.noiseZStep;this.geometry.vertices[this.i*2].x=this.location.previous.x-this.canvasSize.width/2;this.geometry.vertices[this.i*2].y=this.location.previous.y-this.canvasSize.height/2;this.geometry.vertices[this.i*2+1].x=this.location.current.x-this.canvasSize.width/2;this.geometry.vertices[this.i*2+1].y=this.location.current.y-this.canvasSize.height/2;this.location.previous.x=this.location.current.x;this.location.previous.y=this.location.current.y};function ColorMixer(canvasSize,paletteScaleFactor,customBlend,emotionsColors,emotionsList,_blendFactor,originalNoiseSeed,originalNoiseDet){this.blendFactor=_blendFactor;this.mixedVbo=[[]];var colorData1=emotionsColors[emotionsList[0]];var colorData2=emotionsColors[emotionsList[1]];this.customBlend=customBlend;this.canvasSize=canvasSize;this.palettes=[new Palette(canvasSize.width,canvasSize.height,paletteScaleFactor,colorData1,originalNoiseSeed,originalNoiseDet),new Palette(canvasSize.width,canvasSize.height,paletteScaleFactor,colorData2,originalNoiseSeed,originalNoiseDet)];this.createMixedPalette()}ColorMixer.prototype.getColor=function(x,y){return this.mixedVbo[x][y]};ColorMixer.prototype.createMixedPalette=function(){var c1,c2,c;for(var x=0;x<this.canvasSize.width;x++){this.mixedVbo[x]=[];for(var y=0;y<this.canvasSize.height;y++){c1=this.palettes[0].getColor(x,y);c2=this.palettes[1].getColor(x,y);c=this.mixColors(c1,c2);this.mixedVbo[x].push(c)}}};ColorMixer.prototype.mixColors=function(c1,c2){if(this.customBlend){if(c1[1]<c2[1]*this.blendFactor)return c2;else return c1}};function HSB2HSL(h,s,b){var l=(2-s)*b/2;s=l&&l<1?s*b/(l<.5?l*2:2-l*2):s;return[h,s,l]}function getQueryVariable(variable){var query=window.location.search.substring(1);var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");if(pair[0]==variable){return pair[1]}}return null}(function(global){var module=global.swarm={};var basePath,canvasSize,resizedCanvas;module.create=function(containerClassName,_basePath){var container=document.getElementsByClassName(containerClassName)[0];settings.container=container;canvasSize={width:container.offsetWidth,height:container.offsetHeight};if(canvasSize.width>canvasSize.height){resizedCanvas={width:600,height:600/(container.offsetWidth/container.offsetHeight)}}else{resizedCanvas={width:600/(container.offsetHeight/container.offsetWidth),height:600}}if(settings.debug)console.log("container: ",container.offsetWidth,container.offsetHeight);if(settings.debug)console.log("resizedCanvas: ",resizedCanvas);settings.originalSize=Object.create(canvasSize);basePath=_basePath;getData()};module.resize=function(){canvasSize={width:settings.container.offsetWidth,height:settings.container.offsetHeight}};module.testNewColor=function(){settings.emotions=["anger","surprise"];settings.word="alarmed";update()};var limits={range:50};var settings={debug:false,agents:7e4,minAgents:4e4,sizeAgentRatio:.038,fadeAlpha:0,noiseDet:5,noiseSeed:Math.random()*1e4,overlayAlpha:0,blendFactor:.2,paletteScaleFactor:1,customBlend:true,imageChoice:0,debug:false,emotions:["joy","anger"],dominantEmotionProportion:.5,fetchPeriod:60};settings.debug=getQueryVariable("debug")=="true"?true:false;var agentDefaults={noiseScale:100,randomSeed:0,agentsAlpha:20,strokeWidth:2,maxAngleSpan:220,speed:3,interAgentNoiseZRange:0,noiseZStep:.001,randomInitialDirection:0};var emotionsColors={anger:[19,.05,.9],joy:[55,.02,.9],calm:[0,.1,.8],disgust:[162,.1,.8],sadness:[190,.1,.8],fear:[210,.1,.8],surprise:[285,.1,.65],love:[0,.1,.8]};if(window.debug)var stats=new Stats;var agents=[];var colorMixer;var camera,scene,renderer,geometry;geometry=new THREE.Geometry;var started=false;function getData(){function reqListener(){if(req.status=="404"){reqFailed();return}var data=JSON.parse(req.responseText);settings.emotions=[data.dominant[0][0],data.dominant[1][0]];settings.blendFactor=data.dominant[1][1]/data.dominant[0][1];settings.word=data.word;settings.dominantEmotionProportion=data.dominant[0][1];var action=started?update:init;action()}function reqFailed(){console.error("Swarm: failed to connect to sentiment service, loading default emotions");settings.emotions=["joy","love"];settings.word="joyful";settings.dominantEmotionProportion=.5;var action=started?update:init;action()}var req=new XMLHttpRequest;req.addEventListener("load",reqListener);req.addEventListener("error",reqFailed);req.open("GET",basePath+"/sentiment/");req.send();setTimeout(getData,settings.fetchPeriod*1e3)}function createColorMixer(){colorMixer=new ColorMixer(resizedCanvas,settings.paletteScaleFactor,settings.customBlend,emotionsColors,settings.emotions,settings.blendFactor,settings.noiseSeed,settings.noiseDet);for(var i=0;i<agents.length;i++){agents[i].newColorMixer(colorMixer)}}function update(){createColorMixer();updateOverlay(settings.word,[emotionsColors[settings.emotions[0]],emotionsColors[settings.emotions[1]]])}function init(){started=true;addOverlay(settings.word,[emotionsColors[settings.emotions[0]],emotionsColors[settings.emotions[1]]]);var supportsWebGL=function(){if(function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return false}}()){var _canvas=document.createElement("canvas");var _gl=_canvas.getContext("webgl")||_canvas.getContext("experimental-webgl");var errors;try{_gl.clearStencil(0);errors=_gl.getError()}catch(e){return false}return errors===0}else{return false}}();var iOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(!supportsWebGL||iOS){addFallbackImage(settings.emotions);return}createColorMixer();settings.agents=Math.max(settings.minAgents,canvasSize.width*canvasSize.height*settings.sizeAgentRatio);if(settings.debug)console.log("Num of agents: ",settings.agents);if(settings.debug)console.log("noiseScale: ",agentDefaults.noiseScale);camera=new THREE.OrthographicCamera(resizedCanvas.width/-2,resizedCanvas.width/2,resizedCanvas.height/2,resizedCanvas.height/-2,.1,1e4);camera.position.set(0,0,-450);scene=new THREE.Scene;var material=new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors,opacity:.1,transparent:true,linewidth:1});for(var i=0;i<settings.agents;i++)agents.push(new Agent(i,agentDefaults,resizedCanvas,limits,geometry,colorMixer));var line=new THREE.LineSegments(geometry,material);scene.add(line);if(settings.debug===true){var cubeGeometry=new THREE.BoxGeometry(14,14,14);var cubeMaterial=new THREE.MeshLambertMaterial;cubeMaterial.color=new THREE.Color(255,0,0);var cube=new THREE.Mesh(cubeGeometry,cubeMaterial);cube.position.x=resizedCanvas.width/-2;cube.position.y=resizedCanvas.height/-2;cube.position.z=0;scene.add(cube);var cube=new THREE.Mesh(cubeGeometry,cubeMaterial);cube.position.x=resizedCanvas.width/2;cube.position.y=resizedCanvas.height/-2;cube.position.z=0;scene.add(cube);var cube=new THREE.Mesh(cubeGeometry,cubeMaterial);cube.position.x=resizedCanvas.width/2;cube.position.y=resizedCanvas.height/2;cube.position.z=0;scene.add(cube);var cube=new THREE.Mesh(cubeGeometry,cubeMaterial);cube.position.x=resizedCanvas.width/-2;cube.position.y=resizedCanvas.height/2;cube.position.z=0;scene.add(cube)}renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:true,alpha:true});renderer.setClearColor(16777215,0);renderer.setPixelRatio(window.devicePixelRatio);renderer.setSize(canvasSize.width,canvasSize.height);renderer.sortObjects=false;renderer.autoClearColor=false;camera.lookAt(scene.position);settings.container.appendChild(renderer.domElement);if(settings.debug===true){if(window.debug)stats.showPanel(1);if(window.debug)document.body.appendChild(stats.dom)}myDraw()}function onResize(){location.reload()}global.addEventListener("resize",onResize);function myDraw(){if(window.debug)stats.begin();for(var i=0;i<agents.length;i++){agents[i].update()}if(window.debug)stats.end();geometry.verticesNeedUpdate=true;geometry.colorsNeedUpdate=true;renderer.render(scene,camera);requestAnimationFrame(myDraw)}function buildGradients(colors){var alpha=.75;var dominantColor=HSB2HSL(colors[0][0],colors[0][1],colors[0][2]);var subColor=HSB2HSL(colors[1][0],colors[1][1],colors[1][2]);var left="hsla("+subColor[0]+","+100+"%,"+subColor[2]*75+"%, "+alpha+")";var right="hsla("+dominantColor[0]+","+100+"%,"+dominantColor[2]*75+"%,"+alpha+")";var gradient="linear-gradient(70deg, "+left+", "+right+")";left="hsla("+dominantColor[0]+","+100+"%,"+dominantColor[2]*75+"%,"+alpha+")";right="hsla("+dominantColor[0]+","+75+"%,"+dominantColor[2]*75+"%,"+alpha+")";var gradient2="linear-gradient(45deg, "+left+","+right+")";return[gradient,gradient2]}function updateOverlay(emotion,colors){var logo=document.getElementById("swarm-logo");var textA=document.getElementById("swarm-text");var textB=document.getElementById("swarm-emotion-word");var gradients=buildGradients(colors);logo.style.backgroundImage=gradients[0];textA.style.backgroundImage=gradients[0];textB.innerHTML=emotion;textB.style.backgroundImage=gradients[1]}function addFallbackImage(emotions){var background=document.createElement("div");emotions.sort(function(a,b){if(a<b)return-1;if(a>b)return 1;return 0});background.style.backgroundImage="url(assets/fallback-images/"+emotions[0]+"-"+emotions[1]+".jpg)";background.className="fallback-image";settings.container.appendChild(background)}function addOverlay(emotion,colors){if(!emotion)emotion="splendid";var overlay=document.createElement("div");overlay.className="swarm-overlay";var logo=document.createElement("div");logo.className="logo";var text=document.createElement("div");text.className="text";logo.innerHTML='<img src="assets/ssw-logo.png">';var textA=document.createElement("span");var textB=document.createElement("span");textA.appendChild(document.createTextNode("Today the world is feeling"));textB.appendChild(document.createTextNode(emotion));text.appendChild(textA);text.appendChild(textB);var gradients=buildGradients(colors);logo.style.backgroundImage=gradients[0];textA.style.backgroundImage=gradients[0];textB.style.backgroundImage=gradients[1];logo.id="swarm-logo";textA.id="swarm-text";textB.id="swarm-emotion-word";overlay.appendChild(logo);overlay.appendChild(text);overlay.style.width=canvasSize.width+"px";overlay.style.height=canvasSize.height+"px";settings.container.appendChild(overlay)}})(window);(function(global){var module=global.customNoise={};var PERLIN_YWRAPB=4;var PERLIN_YWRAP=1<<PERLIN_YWRAPB;var PERLIN_ZWRAPB=8;var PERLIN_ZWRAP=1<<PERLIN_ZWRAPB;var PERLIN_SIZE=4095;var perlin_octaves=4;var perlin_amp_falloff=.5;var scaled_cosine=function(i){return.5*(1-Math.cos(i*Math.PI))};var perlin;module.noise=function(x,y,z){y=y||0;z=z||0;if(perlin==null){perlin=new Array(PERLIN_SIZE+1);for(var i=0;i<PERLIN_SIZE+1;i++){perlin[i]=Math.random()}}if(x<0){x=-x}if(y<0){y=-y}if(z<0){z=-z}var xi=Math.floor(x),yi=Math.floor(y),zi=Math.floor(z);var xf=x-xi;var yf=y-yi;var zf=z-zi;var rxf,ryf;var r=0;var ampl=.5;var n1,n2,n3;for(var o=0;o<perlin_octaves;o++){var of=xi+(yi<<PERLIN_YWRAPB)+(zi<<PERLIN_ZWRAPB);rxf=scaled_cosine(xf);ryf=scaled_cosine(yf);n1=perlin[of&PERLIN_SIZE];n1+=rxf*(perlin[of+1&PERLIN_SIZE]-n1);n2=perlin[of+PERLIN_YWRAP&PERLIN_SIZE];n2+=rxf*(perlin[of+PERLIN_YWRAP+1&PERLIN_SIZE]-n2);n1+=ryf*(n2-n1);of+=PERLIN_ZWRAP;n2=perlin[of&PERLIN_SIZE];n2+=rxf*(perlin[of+1&PERLIN_SIZE]-n2);n3=perlin[of+PERLIN_YWRAP&PERLIN_SIZE];n3+=rxf*(perlin[of+PERLIN_YWRAP+1&PERLIN_SIZE]-n3);n2+=ryf*(n3-n2);n1+=scaled_cosine(zf)*(n2-n1);r+=n1*ampl;ampl*=perlin_amp_falloff;xi<<=1;xf*=2;yi<<=1;yf*=2;zi<<=1;zf*=2;if(xf>=1){xi++;xf--}if(yf>=1){yi++;yf--}if(zf>=1){zi++;zf--}}return r};module.noiseDetail=function(lod,falloff){if(lod>0){perlin_octaves=lod}if(falloff>0){perlin_amp_falloff=falloff}};module.noiseSeed=function(seed){var lcg=function(){var m=4294967296,a=1664525,c=1013904223,seed,z;return{setSeed:function(val){z=seed=(val==null?Math.random()*m:val)>>>0},getSeed:function(){return seed},rand:function(){z=(a*z+c)%m;return z/m}}}();lcg.setSeed(seed);perlin=new Array(PERLIN_SIZE+1);for(var i=0;i<PERLIN_SIZE+1;i++){perlin[i]=lcg.rand()}}})(window);function Palette(_width,_height,paletteScaleFactor,colorData,originalNoiseSeed,originalNoiseDet){customNoise.noiseDetail(10);customNoise.noiseSeed(Math.random()*1e4);this.paletteScaleFactor=paletteScaleFactor;this.palWidth=_width/paletteScaleFactor;this.palHeight=_height/paletteScaleFactor;this.xPeriod=1;this.yPeriod=1;this.turbPower=2;this.turbSize=170;this.marbleVbo=[[]];this.hueOffset=Math.random()*1e4;this.hueOffsetDebug=this.hueOffset;this.c=colorData[0]/360;this.hueRange=colorData[1];this.minMarbleBrightness=colorData[2];this.noiseStep=600/this.palWidth*.01;this.randomXoffset=Math.random()*1e3;this.randomYoffset=Math.random()*5e3;this.createMarble();customNoise.noiseSeed(originalNoiseSeed);customNoise.noiseDetail(originalNoiseDet)}Palette.prototype.getColor=function(_x,_y){return this.marbleVbo[Math.floor(_x/this.paletteScaleFactor)][Math.floor(_y/this.paletteScaleFactor)]};Palette.prototype.map=function(n,start1,stop1,start2,stop2){return(n-start1)/(stop1-start1)*(stop2-start2)+start2};Palette.prototype.createMarble=function(){for(var x=0;x<this.palWidth;x++){var hueVar=this.c+this.map(customNoise.noise(this.hueOffset),0,1,-this.hueRange,this.hueRange);if(hueVar<0)hueVar+=1;this.marbleVbo[x]=[];for(var y=0;y<this.palHeight;y++){var xyValue=(x+this.randomXoffset)*this.xPeriod/this.palWidth+(y+this.randomYoffset)*this.yPeriod/this.palHeight+this.turbPower*customNoise.noise(x/this.turbSize,y/this.turbSize);var sineValue=Math.abs(Math.sin(xyValue*3.14159));var tempColor=[hueVar,1-sineValue,this.map(sineValue,0,1,this.minMarbleBrightness,1)];this.marbleVbo[x].push(tempColor)}this.hueOffset+=this.noiseStep}};